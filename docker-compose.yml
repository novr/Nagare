# YAML anchorsで共通設定を定義
x-airflow-common: &airflow-common
  build:
    context: .
    dockerfile: docker/Dockerfile.airflow
    args:
      # ローカル開発環境ではテスト実行のため development を指定
      # 本番環境では BUILD_ENV を指定しない（デフォルト: production）
      BUILD_ENV: development
  env_file:
    - .env
  volumes:
    - ./src:/opt/airflow/src:ro
    - ./tests:/opt/airflow/tests:ro
    - ./pyproject.toml:/opt/airflow/pyproject.toml:ro
    - ./connections.yml:/opt/airflow/connections.yml:ro
    - airflow_logs:/opt/airflow/logs
  networks:
    - nagare-network
  restart: unless-stopped

x-airflow-env: &airflow-env # Airflow Core設定
  AIRFLOW__CORE__EXECUTOR: LocalExecutor
  AIRFLOW__CORE__LOAD_EXAMPLES: "false"
  AIRFLOW__CORE__DAGS_FOLDER: /opt/airflow/src/nagare/dags

  # データベース接続（Airflow用）
  AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${DATABASE_USER}:${DATABASE_PASSWORD}@postgres:5432/${DATABASE_NAME}

  # Connection設定ファイルのパス（コンテナ内固有）
  NAGARE_CONNECTIONS_FILE: /opt/airflow/connections.yml

  # アプリケーション設定
  AIRFLOW_ALERT_EMAIL: ${AIRFLOW_ALERT_EMAIL:-admin@example.com}

services:
  # PostgreSQLデータベース
  postgres:
    image: postgres:15-alpine
    container_name: nagare-postgres
    environment:
      POSTGRES_USER: ${DATABASE_USER}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${DATABASE_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nagare-network
    restart: unless-stopped

  # Airflow Webserver
  airflow-webserver:
    <<: *airflow-common
    container_name: nagare-airflow-webserver
    command: airflow webserver
    ports:
      - "${AIRFLOW_WEBSERVER_PORT:-8080}:8080"
    deploy:
      resources:
        limits:
          memory: 4G
    environment:
      <<: *airflow-env
      # Webserver固有の設定
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "false"
      AIRFLOW__WEBSERVER__SECRET_KEY: ${AIRFLOW_SECRET_KEY}
      AIRFLOW__WEBSERVER__WORKERS: 1
      AIRFLOW__WEBSERVER__WORKER_REFRESH_INTERVAL: 1800
      AIRFLOW__WEBSERVER__WORKER_CLASS: sync
      AIRFLOW__WEBSERVER__WEB_SERVER_MASTER_TIMEOUT: 300
      AIRFLOW__WEBSERVER__WEB_SERVER_WORKER_TIMEOUT: 300
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Airflow Scheduler
  airflow-scheduler:
    <<: *airflow-common
    container_name: nagare-airflow-scheduler
    command: airflow scheduler
    deploy:
      resources:
        limits:
          memory: 4G
    environment:
      <<: *airflow-env
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "airflow", "jobs", "check", "--job-type", "SchedulerJob"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Airflow初期化（データベースマイグレーション）
  airflow-init:
    build:
      context: .
      dockerfile: docker/Dockerfile.airflow
    container_name: nagare-airflow-init
    env_file:
      - .env
    entrypoint: /bin/bash
    command:
      - -c
      - |
        # アプリケーションスキーマの初期化
        echo "Initializing application database schema..."
        PGPASSWORD=${DATABASE_PASSWORD} psql -h postgres -U ${DATABASE_USER} -d ${DATABASE_NAME} -f /opt/airflow/scripts/init_db.sql

        # Airflowデータベースのマイグレーション
        echo "Running Airflow database migration..."
        airflow db migrate

        # Airflow管理ユーザーの作成
        echo "Creating Airflow admin user..."
        airflow users create \
          --username ${AIRFLOW_ADMIN_USERNAME:-admin} \
          --password ${AIRFLOW_ADMIN_PASSWORD:-admin} \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email ${AIRFLOW_ALERT_EMAIL:-admin@example.com} || true
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${DATABASE_USER}:${DATABASE_PASSWORD}@postgres:5432/${DATABASE_NAME}
    volumes:
      - ./scripts:/opt/airflow/scripts:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - nagare-network

  # Apache Superset
  superset:
    build:
      context: .
      dockerfile: docker/Dockerfile.superset
    container_name: nagare-superset
    env_file:
      - .env
    environment:
      # Superset設定
      SUPERSET_LOAD_EXAMPLES: "no"

      # PostgreSQLメタデータベース接続（Superset専用データベース）
      # 注: Supersetはnagare_supersetデータベースを使用（Airflowとの衝突を回避）
      SQLALCHEMY_DATABASE_URI: postgresql+psycopg2://${DATABASE_USER}:${DATABASE_PASSWORD}@postgres:5432/nagare_superset

      # Superset管理者ユーザー設定（初期化スクリプトで使用）
      SUPERSET_ADMIN_USERNAME: ${SUPERSET_ADMIN_USERNAME:-admin}
      SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-admin}
      SUPERSET_ADMIN_EMAIL: ${SUPERSET_ADMIN_EMAIL:-admin@example.com}
      SUPERSET_ADMIN_FIRSTNAME: ${SUPERSET_ADMIN_FIRSTNAME:-Admin}
      SUPERSET_ADMIN_LASTNAME: ${SUPERSET_ADMIN_LASTNAME:-User}
    ports:
      - "${SUPERSET_PORT:-8088}:8088"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - superset_data:/app/superset_home
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - nagare-network
    restart: unless-stopped

  # Streamlit管理画面
  streamlit-admin:
    build:
      context: .
      dockerfile: docker/Dockerfile.streamlit
    container_name: nagare-streamlit-admin
    env_file:
      - .env
    ports:
      - "${STREAMLIT_PORT:-8501}:8501"
    volumes:
      - ./connections.yml:/app/connections.yml:ro
    environment:
      # Connection設定ファイルのパス（コンテナ内固有）
      NAGARE_CONNECTIONS_FILE: /app/connections.yml
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - nagare-network
    restart: unless-stopped

volumes:
  postgres_data:
    name: nagare-postgres-data
  airflow_logs:
    name: nagare-airflow-logs
  superset_data:
    name: nagare-superset-data

networks:
  nagare-network:
    name: nagare-network
    driver: bridge
