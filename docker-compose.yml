services:
  # PostgreSQLデータベース
  postgres:
    image: postgres:15-alpine
    container_name: nagare-postgres
    environment:
      POSTGRES_USER: ${DATABASE_USER:-nagare_user}
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      POSTGRES_DB: ${DATABASE_NAME:-nagare}
    secrets:
      - db_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${DATABASE_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-nagare_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nagare-network
    restart: unless-stopped

  # Airflow Webserver
  airflow-webserver:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nagare-airflow-webserver
    command: airflow webserver
    ports:
      - "${AIRFLOW_WEBSERVER_PORT:-8080}:8080"
    deploy:
      resources:
        limits:
          memory: 4G
    environment:
      # Airflow Core設定
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: 'false'
      AIRFLOW__CORE__DAGS_FOLDER: /opt/airflow/src/nagare/dags

      # データベース接続（Airflow用）
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${DATABASE_USER:-nagare_user}:${DATABASE_PASSWORD}@postgres:5432/${DATABASE_NAME:-nagare}

      # データベース接続（アプリケーション用）
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME:-nagare}
      DATABASE_USER: ${DATABASE_USER:-nagare_user}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}

      # Webserver設定
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: 'false'
      AIRFLOW__WEBSERVER__SECRET_KEY_FILE: /run/secrets/airflow_secret_key
      AIRFLOW__WEBSERVER__WORKERS: 1
      AIRFLOW__WEBSERVER__WORKER_REFRESH_INTERVAL: 1800
      AIRFLOW__WEBSERVER__WORKER_CLASS: sync
      AIRFLOW__WEBSERVER__WEB_SERVER_MASTER_TIMEOUT: 300
      AIRFLOW__WEBSERVER__WEB_SERVER_WORKER_TIMEOUT: 300

      # GitHub認証情報
      GITHUB_APP_ID: ${GITHUB_APP_ID}
      GITHUB_APP_INSTALLATION_ID: ${GITHUB_APP_INSTALLATION_ID}
      GITHUB_APP_PRIVATE_KEY: ${GITHUB_APP_PRIVATE_KEY}
      GITHUB_TOKEN: ${GITHUB_TOKEN}

      # アプリケーション設定
      USE_DB_MOCK: ${USE_DB_MOCK:-false}
      REPOSITORIES_JSON: ${REPOSITORIES_JSON}
      AIRFLOW_ALERT_EMAIL: ${AIRFLOW_ALERT_EMAIL:-admin@example.com}
    secrets:
      - airflow_secret_key
    volumes:
      - ./src:/opt/airflow/src:ro
      - airflow_logs:/opt/airflow/logs
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - nagare-network
    restart: unless-stopped

  # Airflow Scheduler
  airflow-scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nagare-airflow-scheduler
    command: airflow scheduler
    deploy:
      resources:
        limits:
          memory: 2G
    environment:
      # Airflow Core設定
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: 'false'
      AIRFLOW__CORE__DAGS_FOLDER: /opt/airflow/src/nagare/dags

      # データベース接続（Airflow用）
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${DATABASE_USER:-nagare_user}:${DATABASE_PASSWORD}@postgres:5432/${DATABASE_NAME:-nagare}

      # データベース接続（アプリケーション用）
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME:-nagare}
      DATABASE_USER: ${DATABASE_USER:-nagare_user}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}

      # GitHub認証情報
      GITHUB_APP_ID: ${GITHUB_APP_ID}
      GITHUB_APP_INSTALLATION_ID: ${GITHUB_APP_INSTALLATION_ID}
      GITHUB_APP_PRIVATE_KEY: ${GITHUB_APP_PRIVATE_KEY}
      GITHUB_TOKEN: ${GITHUB_TOKEN}

      # アプリケーション設定
      USE_DB_MOCK: ${USE_DB_MOCK:-false}
      REPOSITORIES_JSON: ${REPOSITORIES_JSON}
      AIRFLOW_ALERT_EMAIL: ${AIRFLOW_ALERT_EMAIL:-admin@example.com}
    volumes:
      - ./src:/opt/airflow/src:ro
      - airflow_logs:/opt/airflow/logs
    depends_on:
      postgres:
        condition: service_healthy
      airflow-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "airflow", "jobs", "check", "--job-type", "SchedulerJob"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - nagare-network
    restart: unless-stopped

  # Airflow初期化（データベースマイグレーション）
  airflow-init:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nagare-airflow-init
    entrypoint: /bin/bash
    command:
      - -c
      - |
        airflow db migrate
        airflow users create \
          --username ${AIRFLOW_ADMIN_USERNAME:-admin} \
          --password ${AIRFLOW_ADMIN_PASSWORD:-admin} \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email ${AIRFLOW_ALERT_EMAIL:-admin@example.com} || true
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${DATABASE_USER:-nagare_user}:${DATABASE_PASSWORD}@postgres:5432/${DATABASE_NAME:-nagare}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - nagare-network

  # Apache Superset
  superset:
    build:
      context: .
      dockerfile: Dockerfile.superset
    container_name: nagare-superset
    environment:
      SUPERSET_SECRET_KEY: ${SUPERSET_SECRET_KEY}
      DATABASE_DB: ${DATABASE_NAME:-nagare}
      DATABASE_HOST: postgres
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      DATABASE_USER: ${DATABASE_USER:-nagare_user}
      DATABASE_PORT: 5432
      DATABASE_DIALECT: postgresql
      SUPERSET_LOAD_EXAMPLES: 'no'
    ports:
      - "${SUPERSET_PORT:-8088}:8088"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - superset_data:/app/superset_home
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - nagare-network
    restart: unless-stopped

  # Streamlit管理画面
  streamlit-admin:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nagare-streamlit-admin
    entrypoint: []
    command: ["streamlit", "run", "/opt/airflow/src/nagare/admin_app.py", "--server.port", "8501", "--server.address", "0.0.0.0"]
    ports:
      - "${STREAMLIT_PORT:-8501}:8501"
    environment:
      # データベース接続
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME:-nagare}
      DATABASE_USER: ${DATABASE_USER:-nagare_user}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      # GitHub認証情報（リポジトリ検索用）
      GITHUB_APP_ID: ${GITHUB_APP_ID}
      GITHUB_APP_INSTALLATION_ID: ${GITHUB_APP_INSTALLATION_ID}
      GITHUB_APP_PRIVATE_KEY: ${GITHUB_APP_PRIVATE_KEY}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./src:/opt/airflow/src:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - nagare-network
    restart: unless-stopped

volumes:
  postgres_data:
    name: nagare-postgres-data
  airflow_logs:
    name: nagare-airflow-logs
  superset_data:
    name: nagare-superset-data

networks:
  nagare-network:
    name: nagare-network
    driver: bridge

secrets:
  db_password:
    file: ./secrets/db_password.txt
  airflow_secret_key:
    file: ./secrets/airflow_secret_key.txt
  superset_secret_key:
    file: ./secrets/superset_secret_key.txt
