# 01. 機能要件

## 1. ダッシュボード機能

### 1.1. Four Keys メトリクス表示

- 以下の4つの指標を時系列のトレンドグラフで表示する。
  - **デプロイ頻度 (Throughput):** `main`ブランチへのマージ回数などを集計。
  - **変更のリードタイム (Lead Time for Changes):** PR作成からマージまでの時間などを集計。
  - **変更障害率 (Change Failure Rate):** `main`ブランチでのマージビルドの失敗率。
  - **平均修復時間 (MTTR):** `main`ブランチでのビルド失敗から、次の成功までの平均時間。

### 1.2. フィルタリングとドリルダウン

- **フィルタリング:**
  - 表示するデータの期間を自由に指定できる。
  - プロジェクト単位、リポジトリ単位で表示を絞り込める。
- **ドリルダウン:**
  - ダッシュボード上のすべてのグラフや数値から、その根拠となる詳細データ（ビルド一覧、ジョブ一覧など）に掘り下げることができる。
  - 最終的には、CI/CDツール（GitHub Actionsなど）の元ログ画面へ直接遷移できるリンクを提供する。

### 1.3. プロジェクト管理機能

- 複数のリポジトリを「プロジェクト」という単位で論理的にグルーピングできる。
- ユーザーはプロジェクトを作成し、分析対象のリポジトリを自由に関連付けることができる。
- ダッシュボードはプロジェクト単位での指標表示に対応する。

### 1.4. ボトルネック分析支援

- **CI実行時間の分析:**
  - 指定期間内で、実行時間が長いビルドやジョブをランキング表示する。
- **ビルド成功率の分析:**
  - 指定期間内で、失敗回数が多いビルドやジョブをランキング表示する。

## 2. リポジトリ管理機能

### 2.1. リポジトリの登録と管理

- **リポジトリの追加:**
  - ユーザーは監視対象のリポジトリを登録できる。
  - GitHub APIから直接リポジトリを検索してインポートできる。
    - 組織名によるリポジトリ一覧取得
    - ユーザー名によるリポジトリ一覧取得
    - キーワード検索（GitHub検索構文対応）
  - 手動でリポジトリ名（`owner/repo`形式）を入力して登録できる。
  - 複数リポジトリの一括登録に対応する。

- **リポジトリの有効化/無効化:**
  - 登録済みリポジトリの監視を一時停止・再開できる。
  - 無効化されたリポジトリはデータ収集対象から除外される。

- **リポジトリ情報の表示:**
  - 登録済みリポジトリの一覧を表示できる。
  - リポジトリのメタデータ（stars数、forks数、主要言語）を確認できる。
  - 有効/無効ステータスを一目で確認できる。

### 2.2. GitHub連携機能

- **ページネーション:**
  - 大量のリポジトリを検索する際、ページング機能で快適に閲覧できる。
  - ページサイズは10/20/30/50件から選択可能。

- **検索結果の表示:**
  - リポジトリ名、説明、stars数、forks数、主要言語を表示。
  - 既に登録済みのリポジトリは視覚的に区別できる。

## 3. データ収集機能

### 3.1. データ収集の基本方針

- 指定されたリポジトリのCI/CD実行データを、連携ツール（GitHub Actionsなど）のAPIから自動で定期的に収集する。
- 収集したデータは、`02_design/data_model.md` に定義された汎用データモデルに変換してデータベースに保存する。

### 3.2. データ収集の制約と設計

- **GitHub API制約:**
  - Personal Access Tokenは1時間あたり5,000リクエストの制限がある。
  - GitHub Appsは1時間あたり5,000リクエスト（core API）の制限がある。
  - この制約を考慮し、収集対象リポジトリ数と収集頻度を設計する必要がある。
  - 例: 100リポジトリを監視する場合、1リポジトリあたり1時間に50リクエストまで利用可能。

- **収集頻度:**
  - 初期実装では、1時間に1回程度の定期実行を想定。
  - API制約を超えないよう、Airflow DAGで適切なレート制限を実装する。

- **収集範囲:**
  - 新規データの増分収集を基本とする（全データの再取得は行わない）。
  - 初回セットアップ時は、過去24時間分のデータを遡って収集する。

### 3.3. エラーハンドリングと信頼性

- **Rate Limit対策:**
  - GitHub API Rate Limitを監視し、残数が少ない場合は警告を出す。
  - Rate Limitに達した場合、自動的にリセット時刻まで待機する。
  - リセット時刻までの待機時間をログに記録する。

- **リトライ処理:**
  - 一時的なエラー（502 Bad Gateway, 503 Service Unavailable, 504 Gateway Timeout）は自動リトライする。
  - 指数バックオフ戦略（1秒、2秒、4秒）を採用し、最大3回までリトライする。

- **部分的失敗時の継続処理:**
  - 複数リポジトリからデータ収集する際、一部が失敗しても他の処理は継続する。
  - エラー統計（成功数、失敗数、エラー詳細）を記録し、モニタリングに活用する。
  - 全てのリポジトリで失敗した場合のみ、タスクを失敗とする。

- **冪等性の保証:**
  - UPSERT処理により、同じデータを複数回取得しても重複しない。
  - 再実行時のデータ整合性を保証する。
