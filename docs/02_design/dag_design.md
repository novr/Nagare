# 07. Airflow DAG設計原則

本ドキュメントでは、Nagareにおけるデータ収集バッチ処理のAirflow DAG設計ルールを定義する。

## 1. DAG設計の基本原則

### 1.1. 設計原則

- **決定性 (Deterministic):** 同じ入力に対して常に同じ出力を生成する
- **シンプルさ:** DAGの複雑さを最小限に抑え、分析とデバッグを容易にする
- **冪等性 (Idempotency):** 同じタスクを複数回実行しても結果が変わらない（UPSERTを活用）
- **単一責任:** 各タスクは1つの明確な責任のみを持つ
- **疎結合:** タスク間のデータ受け渡しを最小限にする

### 1.2. 必須設定

**DAG定義**
- `catchup=False`: 過去の実行をスキップ
- `start_date`: 固定値を使用（動的な`datetime.now()`は禁止）
- `schedule_interval`: cron形式で明示的に指定
- DAG IDは明確で一意な名前

**default_args**
```python
default_args = {
    "owner": "nagare",
    "depends_on_past": False,
    "email_on_failure": True,
    "email_on_retry": False,
    "retries": 3,           # 1-4回を推奨
    "retry_delay": timedelta(minutes=5),
    "execution_timeout": timedelta(hours=1),
}
```

## 2. タスク設計ルール

### 2.1. タスク分割の原則

**責務の分離**
- データ取得、変換、読み込みを別タスクに分割
- 各タスクは独立してテスト可能であること
- 1つのタスクで複数のリソース種別を扱わない

**タスクの命名規則**
- 動詞で始まる（例: `fetch_`, `transform_`, `load_`）
- 何を処理するか明確にする（例: `fetch_workflow_runs`）
- 過度に長い名前は避ける（最大40文字程度）

### 2.2. タスクの依存関係

**線形フロー**
```python
task1 >> task2 >> task3 >> task4
```

**並列実行の制限**
- MVP版では並列実行を行わない
- `max_active_runs_per_dag=1` を設定

**ExternalTaskSensorの使用**
- 他のDAGに依存する場合のみ使用
- MVP版では使用しない

## 3. データハンドリングルール

### 3.1. XComの使用ルール

**使用が許可される場合**
- 軽量なメタデータ（リポジトリIDのリストなど、10KB以下）
- タスク間の制御情報

**使用が禁止される場合**
- 大きなデータセット（100KB以上）
- バイナリデータ
- APIレスポンスの全体

**代替手段**
- 大きなデータ: 一時テーブルまたはファイルストレージ
- バイナリ: オブジェクトストレージ（S3など）

### 3.2. データの永続化

**一時データ**
- タスク実行中のみ必要なデータはメモリまたはローカルファイル
- タスク完了後は必ずクリーンアップ

**永続データ**
- データベースに保存
- トランザクションを適切に管理
- UPSERTで冪等性を保証

## 4. エラーハンドリングルール

### 4.1. リトライ戦略

**リトライ設定の基準**

| 処理内容 | リトライ回数 | 間隔 | バックオフ |
|---------|------------|------|----------|
| DBアクセス | 3回 | 5分 | なし |
| GitHub API | 3回 | 1分 | 指数（1,2,4分） |
| データ変換 | 0回 | - | - |

**リトライの例外**
- データ変換エラーはリトライしない（ログ記録のみ）
- 認証エラーはリトライしない（即座に失敗）

### 4.2. 部分的な失敗の許容

**原則**
- 1つのリソース（リポジトリ）の失敗が全体に影響しない
- エラーは記録し、処理を継続

**実装パターン**
```python
for resource in resources:
    try:
        process(resource)
    except Exception as e:
        logger.error(f"Failed to process {resource}: {e}")
        continue  # 他のリソースは処理継続
```

### 4.3. アラート条件

- DAGが連続3回失敗: メール/Slack通知
- タスク実行時間が通常の2倍超過: 警告
- API呼び出し数が制限の80%到達: 警告

## 5. パフォーマンス設計ルール

### 5.1. API呼び出しの制約

**GitHub API制約**
- 15,000リクエスト/時間の制限を遵守
- PyGithubがレート制限を自動処理

**並列度の制限**
- MVP版では並列処理を行わない
- 将来的にも並列度は5以下に制限

### 5.2. データベースアクセス

**必須事項**
- バルクINSERT/UPDATEを使用（1件ずつは禁止）
- トランザクションサイズ: 最大1000レコード/トランザクション
- 適切なインデックスの設定（`data_model.md`参照）

**禁止事項**
- N+1クエリ
- SELECT *（必要なカラムのみ指定）
- ループ内でのINSERT

### 5.3. メモリ管理

**制限**
- 1タスクあたりのメモリ使用: 最大1GB
- 大きなデータセットはストリーム処理またはバッチ分割

**推奨**
- ジェネレータの使用
- 適切なデータのチャンク分割

## 6. セキュリティルール

### 6.1. 認証情報の管理

**必須**
- GitHub App tokenは環境変数から取得
- データベース接続情報は環境変数またはSecrets Manager
- コードに認証情報を埋め込まない

**環境変数命名規則**
```
GITHUB_APP_TOKEN
DATABASE_HOST
DATABASE_USER
DATABASE_PASSWORD
```

### 6.2. ログ出力の制限

**禁止事項**
- トークンやパスワードのログ出力
- ユーザーの個人情報
- 完全なAPIレスポンス（要約のみ）

**推奨**
- エラーメッセージは具体的に
- デバッグ情報は適切なログレベルで

## 7. テスト要件

### 7.1. 必須テスト

**DAG検証**
- DAGが正しく読み込まれること
- タスク依存関係が正しいこと
- 循環依存がないこと

**タスクのユニットテスト**
- 各タスク関数の単体テスト
- モックを使用した外部依存の分離
- エッジケースのテスト

### 7.2. テストデータの原則

- 本番データを使用しない
- モックまたはフィクスチャを使用
- テスト用のリポジトリは最小限（1-2個）

## 8. スケジューリングルール

### 8.1. 実行頻度

**メインDAG (`collect_github_actions_data`)**
- 頻度: 1時間に1回
- cron: `0 * * * *` （毎時0分）
- タイムゾーン: UTC

**制約**
- API制約により、これより頻繁な実行は不可
- 1回の実行時間: 30分以内を目標

### 8.2. メンテナンスウィンドウ

- 日本時間の深夜2-3時（UTC 17-18時）はメンテナンス可能時間
- この時間帯のDAG実行は避けることが望ましい

## 9. コード品質ルール

コーディング規約の基本は [AGENT.md](../../../AGENT.md) を参照。

**DAG固有の推奨事項**
- 関数は50行以内
- クラスは200行以内
- 複雑度（Cyclomatic Complexity）は10以下
- Docstring（Google Style）

## 10. 監視・運用ルール

### 10.1. ログレベル

| レベル | 用途 |
|-------|------|
| ERROR | タスク失敗、データ損失の可能性 |
| WARNING | 部分的な失敗、パフォーマンス劣化 |
| INFO | 処理の開始/完了、重要な統計情報 |
| DEBUG | デバッグ情報（本番では無効化） |

### 10.2. メトリクス

**必須メトリクス**
- DAG実行成功率
- タスク実行時間
- API呼び出し数
- 処理したリポジトリ数

**収集方法**
- Airflowのメタデータから自動収集
- カスタムメトリクスはログから抽出

## 11. 拡張性の考慮

### 11.1. 汎用性の原則

**データモデル**
- GitHub Actions固有の名称を避ける
- 汎用的なカラム名（`source`, `source_run_id`）
- 他のCI/CDツール追加を考慮

**コード設計**
- CI/CDツール固有のロジックは分離
- インターフェースの定義
- プラグイン可能な設計

### 11.2. 制限事項の明示

**MVP版の制限**
- GitHub Actionsのみサポート
- 並列実行なし
- 高度な権限管理なし

**将来の拡張**
- GitLab CI、CircleCIのサポート
- 並列処理による高速化
- Row Level Securityによる権限管理

## 12. 参考資料

### 12.1. 関連ドキュメント

- [実装ガイド](./implementation_guide.md) - 具体的な実装方法
- [アーキテクチャ設計](./architecture.md) - システム全体構成
- [データモデル](./data_model.md) - データベーススキーマ

### 12.2. 外部ドキュメント

- [Airflow Best Practices](https://airflow.apache.org/docs/apache-airflow/stable/best-practices.html)
- [PyGithub Documentation](https://pygithub.readthedocs.io/)
- [GitHub REST API - Actions](https://docs.github.com/en/rest/actions/workflow-runs)
